name: jellyfin-with-tailscale

services:
  jellyfin-ts:
    image: tailscale/tailscale:latest
    container_name: jellyfin-ts
    hostname: jellyfin-ts
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve-config.json
      - TS_USERSPACE=false
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
      - ./config/tailscale/serve-config.json:/config/serve-config.json
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
      - NET_RAW
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    user: "1000:1000"
    network_mode: "container:jellyfin-ts"
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - type: bind
        source: /mnt/media
        target: /media
    environment:
      - TZ=Asia/Kathmandu
      - JELLYFIN_PublishedServerUrl=${JELLYFIN_URL}
    restart: unless-stopped
    depends_on:
      - jellyfin-ts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

volumes:
  tailscale-state:
  jellyfin-config:
  jellyfin-cache: